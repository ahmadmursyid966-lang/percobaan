<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile - Kelas 6 Ja'far</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="style.css" rel="stylesheet">
</head>

<body class="bg-black text-white">

    <!-- Top Brand Header (Fixed) -->
    <nav class="navbar fixed-top bg-black border-bottom border-secondary py-2">
        <div class="container-fluid px-3 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-bold" id="ig-header-username">username</span>
                <i class="bi bi-chevron-down small"></i>
            </div>
            <div class="d-flex gap-4 fs-4">
                <!-- Icons removed per user request -->
            </div>
        </div>
    </nav>

    <div class="container py-5 mt-4">
        <!-- View: Jika belum login -->
        <div id="login-required-view" class="text-center py-5 d-none">
            <i class="bi bi-person-lock fs-1 text-white-50 mb-3 d-block"></i>
            <h2 class="fw-bold">Login Terlebih Dahulu</h2>
            <p class="text-white-50 mb-4">Kamu perlu login untuk bisa melihat dan mengedit profilmu di JA'FAR 6.</p>
            <div class="mx-auto" style="max-width: 320px;">
                <div class="glass-card text-start">
                    <label class="form-label small text-white-50">Username</label>
                    <input type="text" id="login-username-input"
                        class="form-control bg-dark border-secondary text-white mb-3" placeholder="Masukkan Username">
                    <button class="btn btn-glow w-100" id="login-btn-profile">Login Sekarang</button>
                </div>
            </div>
            <a href="index.html" class="btn btn-link mt-4 text-white-50 text-decoration-none">
                <i class="bi bi-arrow-left me-1"></i> Kembali ke Beranda
            </a>
        </div>

        <!-- View: Instagram Profile View (Photo 2) -->
        <div id="ig-profile-view" class="ig-profile-container d-none">
            <!-- Header Info -->
            <div class="ig-header-premium text-center">
                <div class="ig-avatar-wrapper mx-auto mb-3">
                    <img id="ig-profile-pic" src="img/default-profile.png" class="ig-avatar-premium" alt="Profile"
                        onerror="this.src='img/default-profile.png'">
                    <div class="ig-avatar-badge"><i class="bi bi-plus"></i></div>
                </div>

                <h4 class="fw-bold mb-1" id="ig-display-name">Display Name</h4>
                <div class="ig-bio-section mb-3">
                    <p class="ig-bio-text text-white-50" id="ig-bio">No bio yet.</p>
                </div>


                <!-- Stats Section -->
                <div class="ig-stats-premium d-flex justify-content-center gap-4 mb-4">
                    <div class="text-center">
                        <span class="d-block fw-bold fs-5" id="ig-followers-count">0</span>
                        <span class="small text-white-50">Followers</span>
                    </div>
                    <div class="text-center">
                        <span class="d-block fw-bold fs-5" id="ig-following-count">0</span>
                        <span class="small text-white-50">Following</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="ig-actions d-flex justify-content-center gap-2 mb-4">
                    <button id="btn-edit-profile" class="btn btn-premium-primary px-4" onclick="showEditView()">Edit
                        Profile</button>
                </div>
            </div>

            <!-- Divider -->
            <hr class="border-secondary opacity-50 my-4">

        </div>

        <!-- View: Edit Profile (Photo 3) -->
        <div id="ig-edit-view" class="d-none">
            <div class="d-flex align-items-center mb-4">
                <button class="btn text-white p-0 me-3" onclick="showProfileView()"><i
                        class="bi bi-arrow-left fs-4"></i></button>
            </div>

            <div class="mb-4 text-center">
                <img id="profile-preview" src="" alt="Profile Picture" class="rounded-circle border border-secondary"
                    width="120" height="120" style="object-fit: cover;" onerror="this.src='img/default-profile.png'">
                <div class="mt-2">
                    <label for="picture-input" class="text-primary fw-bold small cursor-pointer">Edit picture or
                        avatar</label>
                    <input type="file" id="picture-input" class="d-none" accept="image/*">
                </div>
            </div>

            <div class="glass-card mb-4 p-3">
                <div class="mb-3">
                    <label for="username-input" class="form-label text-white-50 small">Username</label>
                    <input type="text" class="form-control bg-dark border-secondary text-white" id="username-input"
                        placeholder="Enter username">
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50 small">Bio</label>
                    <textarea id="bio-input" class="form-control bg-dark border-secondary text-white" rows="3"
                        placeholder="Tulis bio kamu..."></textarea>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-primary fw-bold" id="save-btn">Save Changes</button>
                <button class="btn btn-outline-secondary" id="reset-btn">Reset to Default</button>
                <button class="btn btn-outline-danger" id="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, updateDoc, getDoc } from './firebase-config.js';
        import { initProfileStats } from './social.js';

        window.showEditView = function () {
            document.getElementById('ig-profile-view').classList.add('d-none');
            document.getElementById('ig-edit-view').classList.remove('d-none');
        };

        window.showProfileView = function () {
            document.getElementById('ig-profile-view').classList.remove('d-none');
            document.getElementById('ig-edit-view').classList.add('d-none');
        };

        // Helper: Run stats on load
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const targetUser = urlParams.get('u');
            const currentUser = localStorage.getItem('username');
            const loginView = document.getElementById('login-required-view');
            const profileView = document.getElementById('ig-profile-view');

            if (!currentUser && !targetUser) {
                loginView.classList.remove('d-none');
                return;
            }

            profileView.classList.remove('d-none');

            // Which user are we viewing? 
            const displayUser = targetUser || currentUser;
            const isOwnProfile = displayUser === currentUser;

            // Hide edit actions if not own profile
            const btnEdit = document.getElementById('btn-edit-profile');

            if (!isOwnProfile) {
                // Viewing other profile: Hide Edit
                if (btnEdit) btnEdit.style.display = 'none';

                document.getElementById('ig-header-username').textContent = `Profil ${displayUser}`;
            } else {
                // Own profile: Show Edit
                if (btnEdit) btnEdit.style.display = 'inline-block';

                document.getElementById('ig-header-username').textContent = currentUser;
            }

            // Sync display name
            document.getElementById('ig-display-name').textContent = displayUser;
            document.getElementById('username-input').value = displayUser;

            // Load saved data from Firestore (more reliable for shared profiles)
            try {
                const userDoc = await getDoc(doc(db, 'users', displayUser));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    const pic = data.img || 'img/default-profile.png';
                    const bio = data.bio || "No bio yet.";

                    document.getElementById('ig-profile-pic').src = pic;
                    document.getElementById('ig-bio').textContent = bio;

                    if (isOwnProfile) {
                        document.getElementById('profile-preview').src = pic;
                        document.getElementById('bio-input').value = bio;
                    }
                } else if (isOwnProfile) {
                    // Fallback to local storage if it's own profile and DB is empty (rare)
                    const savedPic = localStorage.getItem('profilePicture') || 'img/default-profile.png';
                    document.getElementById('ig-profile-pic').src = savedPic;
                    document.getElementById('profile-preview').src = savedPic;
                    const savedBio = localStorage.getItem('bio') || "No bio yet.";
                    document.getElementById('ig-bio').textContent = savedBio;
                    document.getElementById('bio-input').value = savedBio;
                }
            } catch (e) {
                console.error("Error fetching user profile:", e);
            }

            if (document.getElementById('bottom-nav-profile') && currentUser) {
                const myPic = localStorage.getItem('profilePicture') || 'img/default-profile.png';
                document.getElementById('bottom-nav-profile').src = myPic;
            }

            // Init stats for the displayed user
            initProfileStats(displayUser);
        });

        // Login from profile page logic
        document.getElementById('login-btn-profile')?.addEventListener('click', function () {
            const username = document.getElementById('login-username-input').value.trim();
            if (username === '') {
                alert('Masukkan username dulu ya!');
                return;
            }
            localStorage.setItem('username', username);
            window.location.reload();
        });

        // Preview selected image
        document.getElementById('picture-input').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('profile-preview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Save Logic
        document.getElementById('save-btn').addEventListener('click', async function () {
            const dataUrl = document.getElementById('profile-preview').src;
            const newUsername = document.getElementById('username-input').value.trim();
            const newBio = document.getElementById('bio-input').value.trim();
            const savedUsername = localStorage.getItem('username');

            if (newUsername === '') {
                alert('Username cannot be empty');
                return;
            }

            localStorage.setItem('profilePicture', dataUrl);
            localStorage.setItem('username', newUsername);
            localStorage.setItem('bio', newBio);

            try {
                const userRef = doc(db, 'users', savedUsername || newUsername);
                await updateDoc(userRef, {
                    img: dataUrl,
                    bio: newBio
                });
            } catch (e) {
                console.error("Error updating profile:", e);
            }

            alert('Profile Saved!');
            window.location.reload();
        });

        // Reset to Default
        document.getElementById('reset-btn').addEventListener('click', function () {
            document.getElementById('profile-preview').src = 'img/default-profile.png';
        });

        // Logout Logic
        document.getElementById('logout-btn').addEventListener('click', function () {
            localStorage.removeItem('username');
            window.location.href = 'index.html';
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="social.js"></script>
    <!-- Instagram-style Bottom Nav -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item">
            <i class="bi bi-house-door-fill"></i>
        </a>
        <a href="index.html#gallery" class="bottom-nav-item">
            <i class="bi bi-grid-3x3"></i>
        </a>
        <a href="menfess.html" class="bottom-nav-item">
            <i class="bi bi-plus-square"></i>
        </a>
        <a href="chat.html" class="bottom-nav-item">
            <i class="bi bi-chat-dots-fill"></i>
        </a>
        <a href="index.html?openSocial=true" class="bottom-nav-item">
            <i class="bi bi-people-fill"></i>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <img src="img/default-profile.png" id="bottom-nav-profile" class="nav-profile-img"
                onerror="this.src='img/default-profile.png'">
        </a>
    </nav>

</body>

</html>